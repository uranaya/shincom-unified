<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>決済確認中</title>
</head>
<body>
    <h1>決済確認中です...</h1>
    <p id="status">しばらくお待ちください。</p>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // URLのクエリパラメータから uuid を取得
        const params = new URLSearchParams(window.location.search);
        const uuid = params.get('uuid');
        if (!uuid) {
            document.getElementById('status').innerText = 'UUID が指定されていません。';
            return;
        }

        let checks = 0;
        const maxChecks = 5;  // 5回チェック (約10秒)
        const interval = 2000; // 2秒間隔でポーリング

        // 一定間隔で verify_payment を呼び出す（setInterval を使用）
        const timerId = setInterval(function() {
            fetch(`/verify_payment/${uuid}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'paid') {
                        // 決済完了。リダイレクト先が返ってくる想定
                        clearInterval(timerId);
                        window.location.href = data.redirect;
                    } else {
                        checks += 1;
                        if (checks >= maxChecks) {
                            // タイムアウト（未決済と判断）
                            clearInterval(timerId);
                            document.getElementById('status').innerText = '未決済です。購入が完了していませんでした。';
                        }
                    }
                })
                .catch(error => {
                    console.error('Payment verify error:', error);
                    clearInterval(timerId);
                    document.getElementById('status').innerText = 'エラーが発生しました。';
                });
        }, interval);
    });
    </script>
</body>
</html>
