<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>スマホ専用鑑定フォーム</title>
  <style>
    video, canvas { width: 100%; max-width: 600px; margin: 10px 0; }
    .btn { padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>手相鑑定（スマホ用）</h1>
  
  <video id="video" autoplay playsinline></video>
  <canvas id="myCanvas" style="display:none;"></canvas>

  <div>
    <button class="btn" onclick="switchCamera()">📷 カメラ切替</button>
    <button class="btn" onclick="takePhoto()">📸 撮影</button>
    <button class="btn" onclick="submitForm()">📤 送信</button>
  </div>

  <form id="fortuneForm">
    <label>生年月日: <input type="date" id="birthdate" name="birthdate" required></label><br>
    <label><input type="checkbox" id="include_yearly" name="include_yearly"> 1年分の運勢も含める</label>
  </form>

  <script>
    let video = document.getElementById('video');
    let canvas = document.getElementById('myCanvas');
    let ctx = canvas.getContext('2d');
    let currentStream = null;
    let useFrontCamera = true;

    async function startCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }
      const constraints = {
        video: {
          facingMode: useFrontCamera ? "user" : "environment"
        }
      };
      try {
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = currentStream;
      } catch (err) {
        alert("カメラの起動に失敗しました: " + err);
      }
    }

    function switchCamera() {
      useFrontCamera = !useFrontCamera;
      startCamera();
    }

    function takePhoto() {
      const scale = 0.5; // 縮小倍率（例: 50%）
      const width = video.videoWidth * scale;
      const height = video.videoHeight * scale;
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(video, 0, 0, width, height);
      canvas.style.display = 'block';
      alert("📷 撮影完了しました！");
    }

    function submitForm() {
      const dataURL = canvas.toDataURL("image/jpeg", 0.8);
      const birthdate = document.getElementById("birthdate").value;
      const includeYearly = document.getElementById("include_yearly").checked;

      const payload = {
        image: dataURL,
        birthdate: birthdate,
        include_yearly: includeYearly
      };

      fetch("/selfmob_submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(response => {
        if (!response.ok) throw new Error("送信エラー: " + response.status);
        return response.blob();
      })
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        window.open(url, "_blank");
      })
      .catch(err => {
        alert("送信失敗: " + err);
        console.error("送信失敗", err);
      });
    }

    window.onload = startCamera;
  </script>
</body>
</html>
