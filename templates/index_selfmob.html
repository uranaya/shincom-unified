<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¹ãƒãƒ›å°‚ç”¨é‘‘å®šãƒ•ã‚©ãƒ¼ãƒ </title>
  <style>
    video, canvas { width: 100%; max-width: 600px; margin: 10px 0; }
    .btn { padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>æ‰‹ç›¸é‘‘å®šï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰</h1>
  
  <video id="video" autoplay playsinline></video>
  <canvas id="myCanvas" style="display:none;"></canvas>

  <div>
    <button class="btn" onclick="switchCamera()">ğŸ“· ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
    <button class="btn" onclick="takePhoto()">ğŸ“¸ æ’®å½±</button>
    <button class="btn" onclick="submitForm()">ğŸ“¤ é€ä¿¡</button>
  </div>

  <form id="fortuneForm">
    <label>ç”Ÿå¹´æœˆæ—¥: <input type="date" id="birthdate" name="birthdate" required></label><br>
    <label><input type="checkbox" id="include_yearly" name="include_yearly"> 1å¹´åˆ†ã®é‹å‹¢ã‚‚å«ã‚ã‚‹</label>
  </form>

  <script>
    let video = document.getElementById('video');
    let canvas = document.getElementById('myCanvas');
    let ctx = canvas.getContext('2d');
    let currentStream = null;
    let useFrontCamera = true;

    async function startCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }
      const constraints = {
        video: {
          facingMode: useFrontCamera ? "user" : "environment"
        }
      };
      try {
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = currentStream;
      } catch (err) {
        alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
      }
    }

    function switchCamera() {
      useFrontCamera = !useFrontCamera;
      startCamera();
    }

    function takePhoto() {
      const scale = 0.5; // ç¸®å°å€ç‡ï¼ˆä¾‹: 50%ï¼‰
      const width = video.videoWidth * scale;
      const height = video.videoHeight * scale;
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(video, 0, 0, width, height);
      canvas.style.display = 'block';
      alert("ğŸ“· æ’®å½±å®Œäº†ã—ã¾ã—ãŸï¼");
    }

    function submitForm() {
      const dataURL = canvas.toDataURL("image/jpeg", 0.8);
      const birthdate = document.getElementById("birthdate").value;
      const includeYearly = document.getElementById("include_yearly").checked;

      const payload = {
        image: dataURL,
        birthdate: birthdate,
        include_yearly: includeYearly
      };

      fetch("/selfmob_submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(response => {
        if (!response.ok) throw new Error("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + response.status);
        return response.blob();
      })
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        window.open(url, "_blank");
      })
      .catch(err => {
        alert("é€ä¿¡å¤±æ•—: " + err);
        console.error("é€ä¿¡å¤±æ•—", err);
      });
    }

    window.onload = startCamera;
  </script>
</body>
</html>
