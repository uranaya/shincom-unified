<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>手相鑑定 - 撮影</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            text-align: center;
        }
        video, canvas {
            width: 90%;
            max-width: 400px;
            margin: 10px 0;
            border: 1px solid #ccc;
        }
        .button-group {
            margin: 10px;
        }
    </style>
</head>
<body>
    <h1>手相鑑定</h1>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <div class="button-group">
        <button id="switch-camera">カメラ切り替え</button>
        <button id="capture">写真を撮る</button>
    </div>

    <form id="form" method="post" enctype="multipart/form-data">
        <input type="hidden" name="image_data" id="image_data" />
        <input type="date" name="birthdate" required /><br /><br />
        <button type="submit">送信</button>
    </form>

    <script>
        let currentStream;
        let usingFrontCamera = false;

        const constraints = {
            audio: false,
            video: {
                facingMode: "environment"
            }
        };

        async function startCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            constraints.video.facingMode = usingFrontCamera ? "user" : "environment";
            try {
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById("video").srcObject = currentStream;
            } catch (err) {
                alert("カメラにアクセスできません: " + err);
            }
        }

        document.getElementById("switch-camera").addEventListener("click", () => {
            usingFrontCamera = !usingFrontCamera;
            startCamera();
        });

        document.getElementById("capture").addEventListener("click", () => {
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = canvas.toDataURL("image/jpeg", 0.8);  // 軽量化
            document.getElementById("image_data").value = imageData;
        });

        document.getElementById("form").addEventListener("submit", (e) => {
            const imageData = document.getElementById("image_data").value;
            if (!imageData) {
                alert("写真を撮影してください");
                e.preventDefault();
            }
        });

        // 初期カメラ起動
        startCamera();
    </script>
</body>
</html>
