<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>手相撮影</title>
</head>
<body>
  <h1>📷 手相を撮影してください</h1>
  <video id="video" autoplay playsinline width="300"></video><br>
  <button onclick="switchCamera()">🔄 カメラ切替</button>
  <button onclick="takePhoto()">📸 撮影</button>
  <canvas id="canvas" style="display:none;"></canvas><br><br>
  <button onclick="submitForm()">✅ 鑑定を開始</button>

  <script>
    let useFrontCamera = true;
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    function startCamera() {
      const constraints = {
        video: { facingMode: useFrontCamera ? "user" : "environment" }
      };
      navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => {
          video.srcObject = stream;
        })
        .catch(err => console.error("カメラ起動エラー:", err));
    }

    function switchCamera() {
      useFrontCamera = !useFrontCamera;
      startCamera();
    }

    function takePhoto() {
      const width = 600;
      const height = video.videoHeight * (600 / video.videoWidth);
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(video, 0, 0, width, height);
      canvas.style.display = "block";
      alert("📷 撮影完了しました！");
    }

    function submitForm() {
      canvas.toBlob(blob => {
        const formData = new FormData();
        formData.append('image_file', blob, 'photo.jpg');
        fetch("/unified", {
          method: "POST",
          body: formData
        })
        .then(response => {
          if (!response.ok) throw new Error("送信失敗");
          return response.blob();
        })
        .then(blob => {
          const url = URL.createObjectURL(blob);
          window.open(url, "_blank");
        })
        .catch(error => {
          console.error("送信エラー:", error);
        });
      }, "image/jpeg", 0.8);
    }

    startCamera();
  </script>
</body>
</html>
