import openai
import re

def generate_tarot_fortune(question: str) -> dict:
    prompt = f"""
ä»¥ä¸‹ã¯ãŠå®¢æ§˜ã‹ã‚‰ã®ã”ç›¸è«‡å†…å®¹ã§ã™ï¼š
ã€Œ{question}ã€

ã“ã®ç›¸è«‡å†…å®¹ã‚’ã‚‚ã¨ã«ã€ç›¸è«‡è€…ãŒæ°—ã«ã—ã¦ã„ã‚‹ã¨æ€ã‚ã‚Œã‚‹ã€Œè³ªå•ã€ã‚’3ï½5å€‹ã«åˆ†è§£ã—ã¦ãã ã•ã„ã€‚
ï¼ˆä¾‹ï¼šç›¸æ‰‹ã¯è‡ªåˆ†ã‚’ã©ã†æ€ã£ã¦ã„ã‚‹ã‹ï¼Ÿï¼è¡Œå‹•ã™ã¹ãã‹ï¼Ÿï¼éšœå®³ã‚„æ³¨æ„ç‚¹ã¯ï¼Ÿï¼æœªæ¥ã®å¯èƒ½æ€§ã¯ï¼Ÿãªã©ï¼‰

ãã‚Œãã‚Œã®è³ªå•ã«å¯¾ã—ã¦ã€1æšã®ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã€ä»¥ä¸‹ã®å½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

ğŸ”¸å ã„ãƒ«ãƒ¼ãƒ«ï¼š
- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰å½¢å¼ã¯ä½¿ã‚ãšã€ä¸€å•ä¸€ç­”ã®å½¢å¼ã¨ã™ã‚‹
- å¤§ã‚¢ãƒ«ã‚«ãƒŠãƒ»å°ã‚¢ãƒ«ã‚«ãƒŠã©ã¡ã‚‰ã‚‚ä½¿ç”¨å¯èƒ½
- æ­£ä½ç½®ãƒ»é€†ä½ç½®ã‚’æ˜è¨˜ã—ã€ãã‚Œã«å¿œã˜ãŸæ„å‘³ã‚’ä½¿ç”¨ã™ã‚‹

ğŸ”¸å‡ºåŠ›å½¢å¼ï¼ˆJSONé¢¨ï¼‰ï¼š
[
  {{ "question": "è³ªå•æ–‡1", "card": "ã‚«ãƒ¼ãƒ‰åï¼ˆæ­£/é€†ï¼‰", "answer": "ãã®ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ã®ä¸å¯§ãªè§£é‡ˆ" }},
  ...
]

ğŸ”¸æœ€å¾Œã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼ˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼‰ï¼š
- å…¨ä½“ã®æµã‚Œã‚’èª­ã¿å–ã‚Šã€ã‚«ãƒ¼ãƒ‰çµæœã‚’çµ±åˆã—ã¦ã€Œç·åˆçš„ãªèª­ã¿è§£ãã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€ï¼ˆ400ï½500æ–‡å­—ï¼‰ã‚’èª å®Ÿã§è¦ªèº«ãªã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°èª¿ã§è¨˜è¿°ã™ã‚‹
- å ã„ã«è©³ã—ããªã„æ–¹ã«ã‚‚ã‚ã‹ã‚Šã‚„ã™ã
- å•†ç”¨åˆ©ç”¨ã§ãã‚‹é‘‘å®šæ–‡ã¨ã—ã¦ã€è‡ªç„¶ã§ä¿¡é ¼æ„Ÿã®ã‚ã‚‹æ—¥æœ¬èªã§

ğŸ”¸å‡ºåŠ›å½¢å¼ã®é †åºï¼š
1. è³ªå•ã”ã¨ã®ã‚«ãƒ¼ãƒ‰ã¨å›ç­”ï¼ˆ3ï½5ä»¶ï¼‰
2. ã€Œã€ç·åˆèª­ã¿è§£ãã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€‘ã€ã¨ã„ã†ãƒ©ãƒ™ãƒ«ã®ã‚ã¨ã«å…¨ä½“ã¾ã¨ã‚

ğŸ”¸æ³¨æ„ç‚¹ï¼š
- JSONæ§‹é€ ã«è¿‘ã„ãŒPythonã§èª­ã¿å–ã‚Œã‚‹è¾æ›¸ã«æ•´å½¢ã—ã‚„ã™ã„å½¢ã«ã—ã¦ãã ã•ã„
- ä¸è¦ãªé£¾ã‚Šæ ã‚„è¡¨ç¾ï¼ˆçµµæ–‡å­—ãªã©ï¼‰ã¯ä½¿ã‚ãšã€ã‚ãã¾ã§ä¸å¯§ã§è‡ªç„¶ãªæ–‡ä½“ã§
"""

    try:
        response = openai.ChatCompletion.create(
            model="gpt-4o",
            messages=[
                {"role": "system", "content": "ã‚ãªãŸã¯ã‚¿ãƒ­ãƒƒãƒˆå ã„ã®å°‚é–€å®¶ã§ã€å„ªã‚ŒãŸæ–‡ç« è¡¨ç¾åŠ›ã‚‚æŒã¤AIå ã„å¸«ã§ã™ã€‚"},
                {"role": "user", "content": prompt},
            ],
            temperature=0.9,
        )
        result_text = response["choices"][0]["message"]["content"].strip()
        parsed = parse_tarot_reply_to_dict(result_text)
        return parsed

    except Exception as e:
        return {"error": f"OpenAIè¨ºæ–­ã‚¨ãƒ©ãƒ¼: {e}"}

def parse_tarot_reply_to_dict(reply_text: str) -> dict:
    question_blocks = re.findall(r'{\s*"question":\s*"(.+?)",\s*"card":\s*"(.+?)",\s*"answer":\s*"(.+?)"\s*}', reply_text, re.DOTALL)
    extra_questions = [
        {"question": q.strip(), "card": c.strip(), "answer": a.strip()}
        for q, c, a in question_blocks
    ]

    summary_match = re.search(r"ã€ç·åˆèª­ã¿è§£ãã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€‘\s*(.*)", reply_text, re.DOTALL)
    summary_advice = summary_match.group(1).strip() if summary_match else ""

    return {
        "extra_questions": extra_questions,
        "summary_advice": summary_advice
    }
