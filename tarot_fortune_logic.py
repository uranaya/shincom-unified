import openai
import re

def generate_tarot_fortune(question: str) -> dict:
    prompt = f"""
ä»¥ä¸‹ã¯ãŠå®¢æ§˜ã‹ã‚‰ã®ã”ç›¸è«‡å†…å®¹ã§ã™ï¼š
ã€Œ{question}ã€

ã“ã®ç›¸è«‡å†…å®¹ã‚’ã‚‚ã¨ã«ã€ä»¥ä¸‹ã®æ§‹æˆã§ã‚¿ãƒ­ãƒƒãƒˆå ã„ã‚’è¡Œã£ã¦ãã ã•ã„ï¼š

ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
ğŸ”®ã€1. å…¨ä½“ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆã‚±ãƒ«ãƒˆåå­—ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ï¼‰ã€‘
- å¤§ã‚¢ãƒ«ã‚«ãƒŠãƒ»å°ã‚¢ãƒ«ã‚«ãƒŠã‚’ä½¿ç”¨
- æ­£ä½ç½®ãƒ»é€†ä½ç½®ã‚’å«ã‚ã¦ã€å„ã‚«ãƒ¼ãƒ‰ã®æ„å‘³ã‚’ãƒã‚¸ã‚·ãƒ§ãƒ³ã«åˆã‚ã›ã¦è§£é‡ˆ
- ä»¥ä¸‹ã®å½¢å¼ã§10æšã‚’å‡ºåŠ›ï¼š

ã€ãƒã‚¸ã‚·ãƒ§ãƒ³åã€‘ï¼ˆã‚«ãƒ¼ãƒ‰åãƒ»æ­£/é€†ä½ç½®ï¼‰
ç°¡æ˜“è§£é‡ˆï¼š
ç›¸è«‡è€…ã¸ã®è§£é‡ˆï¼š

ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
ğŸƒã€2. å€‹åˆ¥è³ªå•ã‚«ãƒ¼ãƒ‰ï¼ˆ3å•ï¼‰ã€‘
ä»¥ä¸‹ã®ã‚ˆã†ãªç›¸è«‡è€…ãŒæ°—ã«ã—ã¦ã„ãã†ãªç–‘å•ã‚’3ã¤æŒ™ã’ã€ãã‚Œãã‚Œã«1æšã‚«ãƒ¼ãƒ‰ã‚’å¼•ã„ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚
ä¾‹ï¼š
- ç›¸æ‰‹ã¯ä»Šã©ã†æ€ã£ã¦ã„ã‚‹ã‹ï¼Ÿ
- ã“ã‚Œã‹ã‚‰ã©ã†å‹•ãã¹ãã‹ï¼Ÿ
- è‡ªåˆ†ã®æ°—æŒã¡ã‚’ã©ã†ä¼ãˆã‚‹ã¹ãã‹ï¼Ÿ

å½¢å¼ï¼š
ã€Q1ã€‘ï¼ˆè³ªå•æ–‡ï¼‰
â–¶ï¸ï¼ˆã‚«ãƒ¼ãƒ‰åãƒ»æ­£/é€†ä½ç½®ï¼‰ï¼šè§£é‡ˆã¨åŠ©è¨€ï¼ˆ200å­—ä»¥å†…ï¼‰

ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
ğŸ’¬ã€3. ç·åˆèª­ã¿è§£ãã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€‘
- 1ã€œ10ã®ã‚±ãƒ«ãƒˆåå­—ãŠã‚ˆã³å€‹åˆ¥è³ªå•ã‚«ãƒ¼ãƒ‰ã®æµã‚Œã‚’ä¸€ã¤ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¨ã—ã¦ã¾ã¨ã‚ã‚‹ã€‚
- çŠ¶æ³ã®æœ¬è³ªã‚„åŸå› ã€ç›¸æ‰‹ã®å¿ƒæƒ…ã€è‡ªåˆ†ã«ã§ãã‚‹ã“ã¨ã€å¯èƒ½æ€§ãªã©ã‚’ã¤ãªã’ã¦å…·ä½“çš„ã«è§£èª¬ã€‚
- æœ€å¾Œã«è¡Œå‹•ã®ãŸã‚ã®ä¸€è¨€ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã§ç· ã‚ã‚‹ã€‚
- ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼çš„ãªå®‰å¿ƒæ„Ÿã‚ã‚‹ãƒˆãƒ¼ãƒ³ã§ã€å¿ƒã«å±Šãæ–‡ç« ã‚’600ã€œ800å­—ç¨‹åº¦ã§ã€‚
ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼

å‡ºåŠ›ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ§‹é€ åŒ–ã—ã¦ã€JSONå½¢å¼ã®è¾æ›¸ã§è¿”ã—ã¦ãã ã•ã„ï¼š

{
  "spread_result": "ï¼ˆã‚±ãƒ«ãƒˆåå­—ã®çµæœï¼‰",
  "extra_questions": [
    {"question": "è³ªå•æ–‡1", "card": "ã‚«ãƒ¼ãƒ‰åï¼ˆæ­£/é€†ï¼‰", "answer": "è§£é‡ˆæ–‡"},
    {"question": "è³ªå•æ–‡2", "card": "ã‚«ãƒ¼ãƒ‰åï¼ˆæ­£/é€†ï¼‰", "answer": "è§£é‡ˆæ–‡"},
    {"question": "è³ªå•æ–‡3", "card": "ã‚«ãƒ¼ãƒ‰åï¼ˆæ­£/é€†ï¼‰", "answer": "è§£é‡ˆæ–‡"}
  ],
  "summary_advice": "ï¼ˆç·åˆèª­ã¿è§£ãã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼‰"
}
"""

    response = openai.ChatCompletion.create(
        model="gpt-4",
        temperature=0.9,
        messages=[{"role": "user", "content": prompt}]
    )

    reply = response["choices"][0]["message"]["content"]
    return parse_tarot_reply_to_dict(reply)  # â†ã“ã‚Œã§ãƒ†ã‚­ã‚¹ãƒˆã‚’è¾æ›¸ã«å¤‰æ›ï¼ˆåˆ¥é€”å®šç¾©ãŒå¿…è¦ï¼‰




def parse_tarot_reply_to_dict(reply_text: str) -> dict:
    # 1. ã‚±ãƒ«ãƒˆåå­—å…¨ä½“ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
    spread_match = re.search(r"ğŸ”®ã€1\. å…¨ä½“ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°.*?ã€‘\n(.*?)\n\nğŸƒã€2\.", reply_text, re.DOTALL)
    spread_result = spread_match.group(1).strip() if spread_match else ""

    # 2. å€‹åˆ¥è³ªå•ï¼ˆ3å•ï¼‰
    question_blocks = re.findall(r"ã€Q\d+ã€‘\s*ï¼ˆ(.*?)ï¼‰\nâ–¶ï¸ï¼ˆ(.*?)ï¼‰ï¼š(.*?)\n", reply_text, re.DOTALL)
    extra_questions = [
        {"question": q.strip(), "card": c.strip(), "answer": a.strip()}
        for q, c, a in question_blocks
    ]

    # 3. ç·åˆèª­ã¿è§£ãã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹
    summary_match = re.search(r"ğŸ’¬ã€3\. ç·åˆèª­ã¿è§£ãã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€‘\n(.*)", reply_text, re.DOTALL)
    summary_advice = summary_match.group(1).strip() if summary_match else ""

    return {
        "spread_result": spread_result,
        "extra_questions": extra_questions,
        "summary_advice": summary_advice
    }

