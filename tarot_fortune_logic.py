import openai

def generate_tarot_fortune(question: str) -> dict:
    prompt = f"""
以下はお客様からのご相談内容です：
「{question}」

この相談に対して、ケルト十字スプレッド（10枚）を使用し、タロット占いを行ってください。

🔸使用ルール
- 大アルカナ・小アルカナの両方を使用可
- 正位置・逆位置を明記し、その意味を文中に反映してください
- 各カードは以下の形式で出力してください：

【ポジション名】（カード名・正/逆位置）
簡易解釈：
相談者への解釈：

🔸構成ルール
1. 最初にカード全体の印象を簡潔に書いてください（30〜50字程度）
2. 上記フォーマットで10枚すべてを順に展開してください
3. 最後に【総合読み解きとアドバイス】という見出しのもとで、10枚の流れを時系列的・心理的に整理し、状況全体を繋げて丁寧に解説してください。
   - 単なる要約ではなく、相談者の人生背景や今後の選択の流れをストーリーのように書いてください
   - その上で、現実的で優しいアドバイスを200〜400字程度で締めてください

🔸文体トーン
- 誠実で落ち着いた丁寧語（敬体）
- 占い初心者にも読みやすく、論理的な流れを重視
- 商業用の鑑定文として使える品質を目指してください

全体で1,200〜1,500字以内におさめてください。
"""

    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[
            {
                "role": "system",
                "content": "あなたは商業印刷物で掲載されるような高品質な鑑定文を執筆する熟練のタロット占い師です。"
            },
            {
                "role": "user",
                "content": prompt
            }
        ]
    )

    result_text = response.choices[0].message.content.strip()

    return {
        "question": question,
        "result_text": result_text
    }
